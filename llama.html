<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"> 
    <link id="style" rel="stylesheet" href="./src/style.css" />
  </head>
  <body>
   <div id="renkon">
      <script type="reactive">
        const llamaModule = import("../lib/llama.js");
        const llama = Behaviors.keep(llamaModule);

        const abortController = Events.fby(new AbortController(), abortHandler, (a, b) => {a.abort(); return new AbortController()});

        const config = {
          params: {model: '/res/model/huggingface/local', max_tokens: 1000},
          // url: "http://substrate.home.arpa/llama-3-8b-instruct/v1/completions"
          url: "http://localhost:8080/completion",
          controller: abortController
        };

        const gen = llama.llama(enter, {...config.params}, config);
        const v = Events.next(gen);

        const logged = Events.fby("", v, (a, b) => {
          if (b.done) return a;
          return a + b.value.data.content});

        document.querySelector("#output").textContent = logged;       

        const abortHandler = Events.input("abort");

        const enter = Events.observe((notify) => {
          const keyDown = (evt) => {
            if (evt.key === "Enter") {
              console.log("enter");
              notify(evt.target.textContent);
            }
          };
          document.querySelector("#input").addEventListener("keydown", keyDown);
          return () => {document.querySelector("#input").removeEventListener("keydown", keyDown)}
        });
      </script>
      <button id="abort">Abort</button>
      <div id="input" style="border: 1px solid black; width:600px" contenteditable></div>
      <div style="height: 20px;"></div>
      <div id="output" style="height: fit-content; border: 1px solid brown; width:600px; min-height: 60px"></div>
   </div>
   <script type="module">
     import("./src/main.js").then((mod) => mod.view());
    </script>
  </body>
</html>
